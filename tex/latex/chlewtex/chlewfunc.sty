\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chlewfunc}
\RequirePackage{keyval}
%
% define command \funcdef[flags]{f}{space}[options]
%
%--------------------------------------------
\newcommand\funcdef@key[1]{%
  \define@key{funcdef}{#1}{\@namedef{fdk@#1}{##1}}%
  \expandafter\let\csname fdk@#1\endcsname\@empty}
\newcommand\funcdef@flag[1]{%
  \define@key{funcdef}{#1}[true]{\@namedef{fdk@#1}{##1}}%
  \expandafter\let\csname fdk@#1\endcsname\@empty}
\newcommand\funcdef@multi[1]{%
  \define@key{funcdef}{#1}{\@namedef{fdk@#1}{\@nameuse{fdk@#1@##1}}}%
  \expandafter\let\csname fdk@#1\endcsname\@empty}
\newcommand\funcdef@alias[2]{%
  \define@key{funcdef}{#1}{\@namedef{fdk@#2}{##1}}}
\funcdef@key{domain}
\funcdef@key{codomain}
\funcdef@key{scalar}
\funcdef@key{coef}
\funcdef@flag{common}
\funcdef@flag{inline}
\funcdef@flag{display}
\funcdef@flag{tabbed}
\funcdef@flag{novars}
\funcdef@flag{operator}
\funcdef@flag{binop}
\funcdef@flag{texop}
\funcdef@key{var}
\funcdef@alias{variable}{var}
\funcdef@alias{vara}{var}
\funcdef@key{varb}
\funcdef@key{variables}
\funcdef@key{notation}
\funcdef@alias{as}{notation}
\funcdef@key{alt}
\funcdef@alias{def}{definition}
\funcdef@key{definition}
\funcdef@key{linedef}
%------------------------------------------------
\newcommand\fdefPH{\ }
\newcommand\fdefIS{\quad}
\newcommand\funcdef[3][]{%
    %\begingroup
    \def\fdk@name{#2}
    \def\fdk@space{#3}
    \setkeys{funcdef}{#1}
    \def\fdk@vars@{(\fdk@vars)}
    \def\funcdef@make{\mathchoice
      {\funcdef@make@common}
      {\funcdef@make@inline}
      {\funcdef@make@inline}
      {\funcdef@make@inline}}
    \def\funcdef@ldsep##1{\relax}
    \let\funcdef@linedef\relax
    \funcdef@}
\newcommand\funcdef@[1][\@empty]{
    \ifx#1\@empty\relax\else\setkeys{funcdef}{#1}\fi
    \ifx\fdk@texop\@empty
      \ifx\fdk@operator\@empty\relax\else
        \def\fdk@vars@{\fdk@vars}
        \let\fdk@name@\fdk@name
        \def\fdk@name{\mathop{\textrm{\fdk@name@}}}
      \fi
    \else
      \let\fdk@name@\fdk@name
      \ifx\fdk@binop\@empty
        \ifx\fdk@scalar\@empty
          \ifx\fdk@coef\@empty
            \ifx\fdk@varb\@empty
              \def\fdk@name{\fdk@name@{\fdefPH}}
            \else
              \def\fdk@name{\fdk@name@{\fdefPH}{\fdefPH}}
            \fi
          \else
            \def\fdk@name{\fdk@name@{\fdefPH}{\fdefPH}}
          \fi
        \else
          \def\fdk@name{\fdk@name@{\fdefPH}{\fdefPH}}
        \fi
      \else
        \def\fdk@name{\fdk@name@{\fdefPH}{\fdefPH}}
      \fi
    \fi
    \ifx\fdk@var\@empty
      \ifx\fdk@variables\@empty
        \ifx\fdk@varb\@empty
          \let\fdk@vars\relax
          \let\fdk@vars@\relax
          \def\funcdef@make{\funcdef@make@novars}
        \else
          \let\fdk@vars\fdk@varb
        \fi
      \else
        \def\fdk@vars{(\fdk@variables)}
        \let\fdk@vars@\fdk@vars
      \fi
    \else
      \ifx\fdk@varb\@empty
        \let\fdk@vars\fdk@var
      \else
        \def\fdk@vars{(\fdk@var,\fdk@varb)}
        \ifx\fdk@notation\@empty
          \ifx\fdk@texop\@empty
            \def\fdk@notation{\fdk@var\mathbin{\fdk@name}\fdk@varb}
          \else
            \def\fdk@notation{\fdk@name@{\fdk@var}{\fdk@varb}}
          \fi
        \fi
      \fi
    \fi
    \ifx\fdk@notation\@empty
      \ifx\fdk@texop\@empty
        \def\fdk@notation{\fdk@name\fdk@vars@}
      \else
        \def\fdk@notation{\fdk@name@{\fdk@vars}}
      \fi
    \fi
    \ifx\fdk@alt\@empty
    \else
      \let\fdk@notation@\fdk@notation
      \def\fdk@notation{\fdk@notation@=\fdk@alt}
    \fi
    \def\funcdef@defblock{\relax}
    \def\funcdef@defblock@s{\relax}
    \ifx\fdk@common\@empty\relax\else
      \def\funcdef@make{\funcdef@make@common}
    \fi
    \ifx\fdk@inline\@empty\relax\else
      \def\funcdef@make{\funcdef@make@inline}
    \fi
    \ifx\fdk@display\@empty\relax\else
      \def\funcdef@make{\funcdef@make@common}
      \def\funcdef@defblock@s{\displaystyle}
    \fi
    \ifx\fdk@tabbed\@empty\relax\else
      \def\funcdef@make{\funcdef@make@tabbed}
    \fi
    \ifx\fdk@novars\@empty\relax\else
      \def\funcdef@make{\funcdef@make@novars}
    \fi
    \ifx\fdk@domain\@empty
      \ifx\fdk@scalar\@empty
        \ifx\fdk@coef\@empty
          \ifx\fdk@binop\@empty
            \let\fdk@domain\fdk@space
          \else
            \def\fdk@domain{\fdk@space\times\fdk@space}
          \fi
        \else
          \def\fdk@domain{\fdk@space\times\fdk@coef}
        \fi
      \else
        \def\fdk@domain{\fdk@scalar\times\fdk@space}
      \fi
    \fi
    \ifx\fdk@codomain\@empty\let\fdk@codomain\fdk@space\fi
    \ifx\fdk@definition\@empty\else
      \def\funcdef@defblock{:={\funcdef@defblock@s\fdk@definition}}
    \fi
    \ifx\fdk@linedef\@empty\relax\else
      \def\funcdef@linedef{\funcdef@ldsep{\funcdef@defblock@s\fdk@linedef}}
    \fi
    \funcdef@make
    %\endgroup
}
%------------------------------------------------
\newcommand\funcdef@make@novars{\fdk@name:\fdk@domain\to\fdk@codomain}
\newcommand\funcdef@make@inline{%
  \def\funcdef@ldsep##1{,\fdefIS##1}%
  \funcdef@make@novars,\fdefIS
    \fdk@vars\mapsto\fdk@notation\funcdef@defblock
    \funcdef@linedef}
\newcommand\funcdef@make@tabbed{%
  \def\funcdef@ldsep##1{&&##1}%
  \edef\tmp{\fdk@name:&\fdk@domain\to\fdk@codomain&\fdk@vars\mapsto\fdk@notation&\funcdef@defblock%\funcdef@ldsep{\fdk@linedef}
  }\tmp}
\newcommand\funcdef@make@common{%
  \def\funcdef@ldsep##1{\\&\multicolumn{2}{@{}l}{##1}}%
  \begin{array}{r@{}c@{}l}
      \fdk@name:{}
    & \fdk@domain
    & {}\to\fdk@codomain \\
    & \fdk@vars
    & {}\mapsto\fdk@notation
      \funcdef@defblock
      \funcdef@linedef
  \end{array}}
\endinput
