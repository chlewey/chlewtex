\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{chlewfunc2}
\RequirePackage{chlewkv}
%
% define command \funcdef[flags]{f}{space}[options]
%
%--------------------------------------------
\chlew@keys{funcdef}
\funcdef@key{domain}
\funcdef@key{codomain}
\funcdef@key{scalar}
\funcdef@key{coef}
\funcdef@flag{common}
\funcdef@flag{inline}
\funcdef@flag{display}
\funcdef@flag{tabbed}
\funcdef@flag{novars}
\funcdef@flag{operator}
\funcdef@flag{binop}
\funcdef@flag{texop}
\funcdef@key{var}
\funcdef@alias{variable}{var}
\funcdef@alias{vara}{var}
\funcdef@key{varb}
\funcdef@key{variables}
\funcdef@key{notation}
\funcdef@alias{as}{notation}
\funcdef@key{alt}
\funcdef@alias{def}{definition}
\funcdef@key{definition}
\funcdef@key{linedef}
%------------------------------------------------
\newcommand\fdefPH{\ }
\newcommand\fdefIS{\quad}
\newcommand\funcdef[3][]{%
    \typeout{*------------* New Function #2}
    \def\funcdef@make{\mathchoice
      {\funcdef@make@common}
      {\funcdef@make@inline}
      {\funcdef@make@inline}
      {\funcdef@make@inline}}
    \funcdef@def{name}{#2}
    \funcdef@def{space}{#3}
    \setkeys{funcdef}{#1}
    \funcdef@def{vars@}{(\funcdef@{vars})}
    \def\funcdef@ldsep##1{\relax}
    \let\funcdef@linedef\relax
    \funcdef@@}
\newcommand\funcdef@@[1][\@empty]{
    \ifx#1\@empty\relax\else\setkeys{funcdef}{#1}\fi
    \ifx\chlew@funcdef@texop\@empty
      %\typeout{--------------------------------------}
      %\funcdef@def{jjjjjjj}{\funcdef@{texop}}
      \ifx\chlew@funcdef@operator\@empty\relax\else
        \funcdef@def{vars@}{\funcdef@{vars}}
        \funcdef@let{name@}{\funcdef@{name}}
        \funcdef@def{name}{\mathop{\textrm{\funcdef@{name@}}}}
      \fi
    \else
      \typeout{--------------------------------------}
      \funcdef@def{name@}{\csname\funcdef@{name}\endcsname}
      \ifx\chlew@funcdef@binop\@empty
        \ifx\chlew@funcdef@scalar\@empty
          \ifx\chlew@funcdef@coef\@empty
            \ifx\chlew@funcdef@varb\@empty
              \funcdef@def{name}{\funcdef@{name@}{\fdefPH}}
            \else
              \funcdef@def{name}{\funcdef@{name@}{\fdefPH}{\fdefPH}}
            \fi
          \else
            \funcdef@def{name}{\funcdef@{name@}{\fdefPH}{\fdefPH}}
          \fi
        \else
          \funcdef@def{name}{\funcdef@{name@}{\fdefPH}{\fdefPH}}
        \fi
      \else
        \funcdef@def{name}{\funcdef@{name@}{\fdefPH}{\fdefPH}}
      \fi
    \fi
    \ifx\chlew@funcdef@var\@empty
      \ifx\chlew@funcdef@variables\@empty
        \ifx\chlew@funcdef@varb\@empty
          \funcdef@let{vars}{\relax}
          \funcdef@let{vars@}{\relax}
          \def\funcdef@make{\funcdef@make@novars}
        \else
          \funcdef@let{vars}{\funcdef@{varb}}
        \fi
      \else
        \funcdef@def{vars}{(\funcdef@{variables})}
        \funcdef@let{vars@}{\funcdef@{vars}}
      \fi
    \else
      \ifx\chlew@funcdef@varb\@empty
        \funcdef@let{vars}{\funcdef@{var}}
      \else
        \funcdef@def{vars}{(\funcdef@{var},\funcdef@{varb})}
        \ifx\chlew@funcdef@notation\@empty
          \ifx\chlew@funcdef@texop\@empty
            \funcdef@def{notation}{\funcdef@{var}\mathbin{\funcdef@{name}}\funcdef@{varb}}
          \else
            \funcdef@def{notation}{\funcdef@{name@}{\funcdef@{var}}{\funcdef@{varb}}}
          \fi
        \fi
      \fi
    \fi
    \ifx\chlew@funcdef@notation\@empty
      \ifx\chlew@funcdef@texop\@empty
        \funcdef@def{notation}{\funcdef@{name}\funcdef@{vars@}}
      \else
        \funcdef@def{notation}{\funcdef@{name@}{\funcdef@{vars}}}
      \fi
    \fi
    \ifx\chlew@funcdef@alt\@empty
    \else
      \funcdef@let{notation@}{\funcdef@{notation}}
      \funcdef@def{notation}{\funcdef@{notation@}=\funcdef@{alt}}
    \fi
    \def\funcdef@defblock{\relax}
    \def\funcdef@defblock@s{\relax}
    \ifx\chlew@funcdef@common\@empty\relax\else
      \def\funcdef@make{\funcdef@make@common}
    \fi
    \ifx\chlew@funcdef@inline\@empty\relax\else
      \def\funcdef@make{\funcdef@make@inline}
    \fi
    \ifx\chlew@funcdef@display\@empty\relax\else
      \def\funcdef@make{\funcdef@make@common}
      \def\funcdef@defblock@s{\displaystyle}
    \fi
    \ifx\chlew@funcdef@tabbed\@empty\relax\else
      \def\funcdef@make{\funcdef@make@tabbed}
    \fi
    \ifx\chlew@funcdef@novars\@empty\relax\else
      \def\funcdef@make{\funcdef@make@novars}
    \fi
    \ifx\chlew@funcdef@domain\@empty
      \ifx\chlew@funcdef@scalar\@empty
        \ifx\chlew@funcdef@coef\@empty
          \ifx\chlew@funcdef@binop\@empty
            \funcdef@def{domain}{\funcdef@{space}}
          \else
            \funcdef@def{domain}{\funcdef@{space}\times\funcdef@{space}}
          \fi
        \else
          \funcdef@def{domain}{\funcdef@{space}\times\funcdef@{coef}}
        \fi
      \else
        \funcdef@def{domain}{\funcdef@{scalar}\times\funcdef@{space}}
      \fi
    \fi
    \ifx\chlew@funcdef@codomain\@empty
      \funcdef@def{codomain}{\funcdef@{space}}
    \fi
    \ifx\chlew@funcdef@definition\@empty\else
      \def\funcdef@defblock{:={\funcdef@defblock@s\funcdef@{definition}}}
    \fi
    \ifx\chlew@funcdef@linedef\@empty\relax\else
      \def\funcdef@linedef{\funcdef@ldsep{\funcdef@defblock@s\funcdef@{linedef}}}
    \fi
    \funcdef@make
}
%------------------------------------------------
\newcommand\funcdef@make@novars{\funcdef@{name}:\funcdef@{domain}\to\funcdef@{codomain}}
\newcommand\funcdef@make@inline{%
  \def\funcdef@ldsep##1{,\fdefIS##1}%
  \funcdef@make@novars,\fdefIS
    \funcdef@{vars}\mapsto\funcdef@{notation}\funcdef@defblock
    \funcdef@linedef}
\newcommand\funcdef@make@tabbed{%
  \def\funcdef@ldsep##1{&##1}%
  \funcdef@make@novars
    & \funcdef@{vars}\mapsto\funcdef@{notation}\funcdef@defblock
    \funcdef@linedef}
\newcommand\funcdef@make@common{%
  \def\funcdef@ldsep##1{\\&\multicolumn{2}{@{}l}{##1}}%
  \begin{array}{r@{}c@{}l}
      \funcdef@{name}:{}
    & \funcdef@{domain}
    & {}\to\funcdef@{codomain} \\
    & \funcdef@{vars}
    & {}\mapsto\funcdef@{notation}
      \funcdef@defblock
      \funcdef@linedef
  \end{array}}
\endinput
